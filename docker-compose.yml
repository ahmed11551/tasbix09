services:
  # Локальная БД (опционально - только для разработки)
  # Если используете внешнюю БД, закомментируйте этот сервис
  # и укажите DATABASE_URL в переменных окружения app сервиса
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: smarttasbih
      POSTGRES_PASSWORD: smarttasbih_password
      POSTGRES_DB: smarttasbih_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smarttasbih -d smarttasbih_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles:
      - local-db  # Запускается только с флагом --profile local-db

  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./server:/app/server:ro
      - ./prisma:/app/prisma:ro
    environment:
      NODE_ENV: production
      # По умолчанию используется внешняя БД из DATABASE_URL
      # Для локальной БД (с --profile local-db) установите:
      # DATABASE_URL: postgresql://smarttasbih:smarttasbih_password@postgres:5432/smarttasbih_db
      # Или создайте .env файл с нужным DATABASE_URL
      DATABASE_URL: ${DATABASE_URL}
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-key-change-in-production-min-32-chars-long}
      TEST_TOKEN: ${TEST_TOKEN:-test_token_123}
      BOT_REPLIKA_API_URL: ${BOT_REPLIKA_API_URL:-https://bot.e-replika.ru}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-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}
      PORT: 5001
    ports:
      - "5001:5001"
    # Если используете внешнюю БД, раскомментируйте и укажите DATABASE_URL:
    # DATABASE_URL: postgresql://user:password@host:port/database
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    user: "0:0"
    command: >
      sh -c "
        echo 'Проверка подключения к базе данных...' &&
        # Не ждем локальную БД, если используется внешняя
        (nc -z postgres 5432 2>/dev/null && echo 'Локальная БД доступна' || echo 'Используется внешняя БД') &&
        sleep 2 &&
        echo 'Исправление прав доступа...' &&
        rm -rf /app/node_modules/.prisma/client 2>/dev/null || true &&
        chown -R nodejs:nodejs /app/node_modules/.prisma 2>/dev/null || true &&
        chown -R nodejs:nodejs /app/dist 2>/dev/null || true &&
        echo 'Генерация Prisma клиента...' &&
        npx prisma generate &&
        chown -R nodejs:nodejs /app/node_modules/.prisma 2>/dev/null || true &&
        echo 'Создание схемы базы данных (без миграций)...' &&
        npx prisma db push --accept-data-loss --skip-generate &&
        chown -R nodejs:nodejs /app/node_modules/.prisma 2>/dev/null || true &&
        echo 'Запуск приложения...' &&
        cd /app &&
        echo 'Проверка файлов...' &&
        ls -la server/index.ts 2>&1 | head -1 &&
        ls -la dist/index.cjs 2>&1 | head -1 &&
        if [ -f server/index.ts ]; then
          echo '✅ server/index.ts найден - запуск через tsx...' &&
          [ -f dist/index.cjs ] && (mv dist/index.cjs dist/index.cjs.backup && echo 'Перемещен dist/index.cjs') || echo 'dist/index.cjs не найден' &&
          NODE_ENV=production PORT=5001 exec npx tsx server/index.ts
        elif [ -f dist/index.cjs ]; then
          echo '⚠️  server/index.ts не найден - запуск из dist/index.cjs...' &&
          exec node dist/index.cjs
        elif [ -f dist/server/index.cjs ]; then
          echo '⚠️  Запуск из dist/server/index.cjs...' &&
          exec node dist/server/index.cjs
        else
          echo '❌ Ошибка: точка входа не найдена' &&
          ls -la dist/ server/ 2>&1 | head -10 &&
          exit 1
        fi
      "
    restart: unless-stopped

volumes:
  postgres_data:

